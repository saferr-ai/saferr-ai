---
import Layout from '../../layouts/Layout.astro';
import { getCollection, type CollectionEntry } from 'astro:content';

// Get all blog posts
const allPosts = await getCollection('blog');

// Sort posts by date (newest first)
const sortedPosts = [...allPosts].sort((a, b) => 
  new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
);

// Function to format date
const formatDate = (date: Date): string => {
  return date.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
};

// Get all unique tags from all blog posts for the sidebar
const allTags = [...new Set(allPosts.flatMap((post: CollectionEntry<'blog'>) => post.data.tags))].sort();
---

<Layout title="Blog - SAFERR AI Lab">
  <div class="container mx-auto px-4 py-12">
    <div class="text-center mb-12">
      <h1 class="text-4xl font-bold mb-4">SAFERR AI Lab Blog</h1>
      <p class="text-lg max-w-3xl mx-auto">
        Exploring the latest research, insights, and breakthroughs in AI safety and alignment.
      </p>
    </div>
    
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
      <!-- Sidebar with tag filters -->
      <div class="lg:col-span-1">
        <div class="sticky top-24 bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
          <h2 class="text-xl font-bold mb-4">Topics</h2>
          <div class="relative">
            <button 
              id="topics-dropdown-button" 
              class="w-full text-left px-4 py-2 bg-white border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 flex justify-between items-center"
            >
              <span id="selected-topics-text">All Topics</span>
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </button>
            
            <div 
              id="topics-dropdown-menu" 
              class="absolute z-10 w-full mt-1 bg-white border-2 border-gray-200 rounded-lg shadow-lg hidden"
            >
              <div class="max-h-96 overflow-y-auto">
                <label class="flex items-center px-4 py-2 hover:bg-gray-100 cursor-pointer">
                  <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600" value="all" checked>
                  <span class="ml-2">All Topics</span>
                </label>
                {allTags.map((tag: string) => (
                  <label class="flex items-center px-4 py-2 hover:bg-gray-100 cursor-pointer">
                    <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600" value={tag}>
                    <span class="ml-2">{tag}</span>
                  </label>
                ))}
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Blog posts list -->
      <div class="lg:col-span-3">
        <div class="space-y-8" id="blog-posts-container">
          {sortedPosts.map((post: CollectionEntry<'blog'>) => (
            <article class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow duration-300 border border-gray-200">
              <div class="flex flex-wrap gap-2 mb-3">
                {post.data.tags.map((tagName: unknown) => {
                  const tagStr = tagName as string;
                  return (
                    <a href={`/blog/tag/${tagStr}`} class="inline-block px-3 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800 hover:bg-blue-200 transition-colors duration-200">
                      {tagStr}
                    </a>
                  );
                })}
              </div>
              
              <h2 class="text-2xl font-bold mb-2">
                <a href={`/blog/${post.slug}`} class="hover:text-blue-600 transition-colors duration-200">{post.data.title}</a>
              </h2>
              
              <div class="flex items-center text-sm text-gray-600 mb-4">
                <span>{post.data.author}</span>
                <span class="mx-2">â€¢</span>
                <time datetime={post.data.date.toISOString()}>{formatDate(post.data.date)}</time>
              </div>
              
              {post.data.image && (
                <div class="mb-4">
                  <img 
                    src={post.data.image} 
                    alt={post.data.title} 
                    class="w-full h-auto rounded-lg object-cover "
                  />
                </div>
              )}
              
              <p class="mb-4 text-gray-700">{post.data.description}</p>
              
              <a href={`/blog/${post.slug}`} class="inline-flex items-center text-blue-600 hover:text-blue-800 transition-colors duration-200">
                Read more
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              </a>
            </article>
          ))}
        </div>

        <!-- Pagination -->
        <div class="flex justify-center mt-8">
          <div class="flex items-center space-x-2" id="pagination-controls">
            <!-- Pagination buttons will be inserted here by JavaScript -->
          </div>
        </div>
      </div>
    </div>
  </div>
</Layout>

<style is:global>
  /* Custom styles for the topics dropdown */
  #topics-dropdown-menu {
    scrollbar-width: thin;
    scrollbar-color: #CBD5E0 #EDF2F7;
  }
  
  #topics-dropdown-menu::-webkit-scrollbar {
    width: 8px;
  }
  
  #topics-dropdown-menu::-webkit-scrollbar-track {
    background: #EDF2F7;
    border-radius: 4px;
  }
  
  #topics-dropdown-menu::-webkit-scrollbar-thumb {
    background-color: #CBD5E0;
    border-radius: 4px;
  }
  
  /* Checkbox styles */
  .form-checkbox {
    border-radius: 0.25rem;
    border-color: #CBD5E0;
  }
  
  .form-checkbox:checked {
    background-color: #2563EB;
    border-color: #2563EB;
  }
</style>

<script>
  // Helper function to convert to Pascal case
  function toPascalCase(str: string): string {
    return str.split(' ')
      .map(word => word.charAt(0).toUpperCase() + word.slice(1))
      .join(' ');
  }

  document.addEventListener('DOMContentLoaded', () => {
    // State for active filters and pagination
    let activeFilters = {
      topics: ['all']
    };
    
    let currentPage = 1;
    const postsPerPage = 5;
    let totalPages = Math.ceil(document.querySelectorAll('#blog-posts-container article').length / postsPerPage);
    
    // Topics handling
    const topicsButton = document.getElementById('topics-dropdown-button');
    const topicsMenu = document.getElementById('topics-dropdown-menu');
    const selectedTopicsText = document.getElementById('selected-topics-text');
    const topicCheckboxes = document.querySelectorAll('input[type="checkbox"][value]');
    
    if (topicsButton && topicsMenu && selectedTopicsText) {
      // Toggle dropdown (mobile only)
      topicsButton.addEventListener('click', () => {
        topicsMenu.classList.toggle('hidden');
      });
      
      // Close dropdown when clicking outside (mobile only)
      document.addEventListener('click', (e) => {
        if (!topicsButton.contains(e.target as Node) && !topicsMenu.contains(e.target as Node)) {
          topicsMenu.classList.add('hidden');
        }
      });
    }
    
    // Handle checkbox changes (both mobile and desktop)
    topicCheckboxes.forEach(checkbox => {
      checkbox.addEventListener('change', () => {
        const allCheckbox = document.querySelector('input[value="all"]') as HTMLInputElement;
        
        if ((checkbox as HTMLInputElement).value === 'all') {
          // If "All" is checked, uncheck others
          topicCheckboxes.forEach(cb => {
            if (cb !== checkbox) {
              (cb as HTMLInputElement).checked = false;
            }
          });
          activeFilters.topics = ['all'];
          if (selectedTopicsText) {
            selectedTopicsText.innerHTML = `<span class="inline-block border border-gray-300 rounded px-2 py-1 bg-gray-50">All Topics</span>`;
          }
        } else {
          // If a specific topic is checked, uncheck "All"
          if (allCheckbox) {
            allCheckbox.checked = false;
          }
          
          // Get all checked topics
          const checkedTopics = Array.from(topicCheckboxes)
            .filter(cb => (cb as HTMLInputElement).checked)
            .map(cb => (cb as HTMLInputElement).value);
          
          if (checkedTopics.length === 0) {
            // If nothing is checked, check "All"
            allCheckbox.checked = true;
            activeFilters.topics = ['all'];
            if (selectedTopicsText) {
              selectedTopicsText.innerHTML = `<span class="inline-block border border-gray-300 rounded px-2 py-1 bg-gray-50">All Topics</span>`;
            }
          } else {
            activeFilters.topics = checkedTopics;
            if (selectedTopicsText) {
              if (checkedTopics.length === 1) {
                selectedTopicsText.innerHTML = `<span class="inline-block border border-gray-300 rounded px-2 py-1 bg-gray-50">${toPascalCase(checkedTopics[0])}</span>`;
              } else {
                selectedTopicsText.innerHTML = checkedTopics
                  .map(topic => `<span class="inline-block border border-gray-300 rounded px-2 py-1 bg-gray-50 mr-2 mb-1">${toPascalCase(topic)}</span>`)
                  .join('');
              }
            }
          }
        }
        
        currentPage = 1;
        filterAndPaginatePosts();
      });
    });

    // Filter and paginate posts
    const filterAndPaginatePosts = () => {
      const posts = document.querySelectorAll('#blog-posts-container article');
      let visibleCount = 0;
      let visiblePosts: Element[] = [];
      
      // First, filter the posts
      posts.forEach(post => {
        const tags = Array.from(post.querySelectorAll('a[href^="/blog/tag/"]'))
          .map(tag => tag.textContent?.trim() || '');
        
        const matchesTopic = activeFilters.topics.includes('all') || 
          tags.some(tag => activeFilters.topics.includes(tag));
        
        if (matchesTopic) {
          visiblePosts.push(post);
          visibleCount++;
        } else {
          (post as HTMLElement).style.display = 'none';
        }
      });
      
      // Update total pages based on visible posts
      totalPages = Math.ceil(visibleCount / postsPerPage);
      if (currentPage > totalPages) {
        currentPage = 1;
      }
      
      // Then, paginate the visible posts
      const startIndex = (currentPage - 1) * postsPerPage;
      const endIndex = startIndex + postsPerPage;
      
      visiblePosts.forEach((post, index) => {
        if (index >= startIndex && index < endIndex) {
          (post as HTMLElement).style.display = 'block';
        } else {
          (post as HTMLElement).style.display = 'none';
        }
      });
      
      updatePaginationControls();
    };

    // Update pagination controls
    const updatePaginationControls = () => {
      const paginationControls = document.getElementById('pagination-controls');
      if (!paginationControls) return;

      let paginationHTML = '';
      
      // Begin button (only show if not on first page)
      if (currentPage > 1) {
        paginationHTML += `
          <button class="inline-flex items-center justify-center min-w-[2.5rem] h-10 px-3 text-sm font-semibold text-gray-600 bg-white border border-gray-200 rounded-full transition-colors hover:bg-gray-50 hover:border-gray-300 hover:text-gray-900" data-page="1" title="First Page">
            Begin
          </button>
        `;
      }
      
      // Previous button (only show if not on first page)
      if (currentPage > 1) {
        paginationHTML += `
          <button class="inline-flex items-center justify-center min-w-[2.5rem] h-10 px-3 text-sm font-semibold text-gray-600 bg-white border border-gray-200 rounded-full transition-colors hover:bg-gray-50 hover:border-gray-300 hover:text-gray-900" data-page="${currentPage - 1}" title="Previous Page">
            Prev
          </button>
        `;
      }
      
      // Page numbers
      const maxVisiblePages = 5;
      let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
      let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
      
      if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
      }
      
      // Add first page and ellipsis if needed
      if (startPage > 1) {
        paginationHTML += `
          <button class="inline-flex items-center justify-center w-10 h-10 text-sm font-medium text-gray-600 bg-white border border-gray-200 rounded-full transition-colors hover:bg-gray-50 hover:border-gray-300 hover:text-gray-900" data-page="1">1</button>
          ${startPage > 2 ? '<span class="inline-flex items-center justify-center w-10 h-10 text-sm font-medium text-gray-500">...</span>' : ''}
        `;
      }
      
      // Add page numbers
      for (let i = startPage; i <= endPage; i++) {
        paginationHTML += `
          <button class="inline-flex items-center justify-center w-10 h-10 text-sm font-medium ${i === currentPage ? 'bg-blue-500 text-white border-blue-500 shadow-sm' : 'text-gray-600 bg-white border border-gray-200 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-900'} border rounded-full transition-colors" data-page="${i}">${i}</button>
        `;
      }
      
      // Add last page and ellipsis if needed
      if (endPage < totalPages) {
        paginationHTML += `
          ${endPage < totalPages - 1 ? '<span class="inline-flex items-center justify-center w-10 h-10 text-sm font-medium text-gray-500">...</span>' : ''}
          <button class="inline-flex items-center justify-center w-10 h-10 text-sm font-medium text-gray-600 bg-white border border-gray-200 rounded-full transition-colors hover:bg-gray-50 hover:border-gray-300 hover:text-gray-900" data-page="${totalPages}">${totalPages}</button>
        `;
      }
      
      // Next button (only show if not on last page)
      if (currentPage < totalPages) {
        paginationHTML += `
          <button class="inline-flex items-center justify-center min-w-[2.5rem] h-10 px-3 text-sm font-semibold text-gray-600 bg-white border border-gray-200 rounded-full transition-colors hover:bg-gray-50 hover:border-gray-300 hover:text-gray-900" data-page="${currentPage + 1}" title="Next Page">
            Next
          </button>
        `;
      }
      
      // Last button (only show if not on last page)
      if (currentPage < totalPages) {
        paginationHTML += `
          <button class="inline-flex items-center justify-center min-w-[2.5rem] h-10 px-3 text-sm font-semibold text-gray-600 bg-white border border-gray-200 rounded-full transition-colors hover:bg-gray-50 hover:border-gray-300 hover:text-gray-900" data-page="${totalPages}" title="Last Page">
            Last
          </button>
        `;
      }
      
      paginationControls.innerHTML = paginationHTML;
      
      // Add click handlers to pagination buttons
      paginationControls.querySelectorAll('button[data-page]').forEach(button => {
        button.addEventListener('click', () => {
          const page = parseInt(button.getAttribute('data-page') || '1');
          if (page !== currentPage) {
            currentPage = page;
            filterAndPaginatePosts();
          }
        });
      });
    };

    // Initialize pagination
    filterAndPaginatePosts();
  });
</script> 